<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Email Generator - Real-Time Domain Discovery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .api-status {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 10px 20px;
            margin-top: 20px;
            display: inline-block;
        }
        
        .api-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        
        .api-active {
            background: #4caf50;
        }
        
        .api-inactive {
            background: #f44336;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .main-content {
            padding: 40px;
        }
        
        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .upload-label {
            display: inline-block;
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .upload-label:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        input[type="file"] {
            display: none;
        }
        
        .company-section {
            display: none;
            margin-top: 30px;
        }
        
        .bulk-actions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .bulk-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .select-all-btn {
            background: #28a745;
            color: white;
        }
        
        .deselect-all-btn {
            background: #dc3545;
            color: white;
        }
        
        .search-online-all-btn {
            background: linear-gradient(135deg, #00d2ff 0%, #3a47d5 100%);
            color: white;
        }
        
        .bulk-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .company-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .company-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .company-card.excluded {
            opacity: 0.5;
            background: #f8f8f8;
        }
        
        .company-card.searching {
            border-color: #00d2ff;
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.3);
        }
        
        .company-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .company-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .company-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .search-online-btn {
            background: linear-gradient(135deg, #00d2ff 0%, #3a47d5 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .search-online-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .search-online-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .source-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            background: #e3f2fd;
            color: #1976d2;
            margin-left: 5px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%);
            color: white;
            margin-left: 10px;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 230, 149, 0.4);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-card h4 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            opacity: 0.9;
        }
        
        .preview-section {
            display: none;
            margin-top: 30px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .preview-table th, .preview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .preview-table tr:hover {
            background: #f8f9fa;
        }
        
        .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .progress-bar {
            display: none;
            background: #f0f0f0;
            border-radius: 10px;
            padding: 5px;
            margin: 20px 0;
        }
        
        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 20px;
            border-radius: 5px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            max-width: 300px;
        }
        
        .notification.success {
            border-left: 4px solid #4caf50;
        }
        
        .notification.error {
            border-left: 4px solid #f44336;
        }
        
        .notification.info {
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <div class="container">
        <div class="header">
            <h1>üöÄ Lead Email Generator Pro</h1>
            <p>AI-Powered Domain Discovery with Gemini 2.5 Flash</p>
            <div class="api-status">
                <span class="api-indicator api-inactive" id="apiIndicator"></span>
                <span id="apiStatus">Gemini AI: Checking...</span>
            </div>
        </div>
        
        <div class="main-content">
            <div class="upload-section">
                <h2>Step 1: Upload Your Lead CSV</h2>
                <p style="margin: 10px 0; color: #666;">Upload your CSV file containing lead information</p>
                <label for="csvFile" class="upload-label">
                    üìÅ Choose CSV File
                </label>
                <input type="file" id="csvFile" accept=".csv">
                <span id="fileName" style="margin-left: 15px; color: #666;"></span>
            </div>
            
            <div class="stats" id="statsSection" style="display: none;">
                <div class="stat-card">
                    <h4 id="totalLeads">0</h4>
                    <p>Total Leads</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <h4 id="uniqueCompanies">0</h4>
                    <p>Unique Companies</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                    <h4 id="emailsGenerated">0</h4>
                    <p>Emails Generated</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #00d2ff 0%, #3a47d5 100%);">
                    <h4 id="onlineSearches">0</h4>
                    <p>Online Searches</p>
                </div>
            </div>
            
            <div class="company-section" id="companySection">
                <h2>Step 2: Configure Company Domains & Email Formats</h2>
                <p style="margin: 10px 0; color: #666;">Click "Search Online" to find real domains automatically</p>
                
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                </div>
                
                <div class="bulk-actions" id="bulkActions"></div>
                <div class="company-grid" id="companyGrid"></div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-primary" onclick="generateEmails()">Generate Emails</button>
                </div>
            </div>
            
            <div class="preview-section" id="previewSection">
                <h2>Step 3: Preview & Download</h2>
                <p style="margin: 10px 0; color: #666;">Review generated emails and download your enhanced lead list</p>
                <div class="loader" id="loader">
                    <div class="spinner"></div>
                </div>
                <table class="preview-table" id="previewTable">
                    <thead>
                        <tr>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Company</th>
                            <th>Generated Email</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody"></tbody>
                </table>
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-success" onclick="downloadCSV()">üì• Download Enhanced CSV</button>
                    <p style="margin-top: 15px; color: #666;">
                        Having issues? Try: 
                        <a href="download_direct.php" style="color: #667eea; font-weight: 600;">Direct Download</a> | 
                        <a href="fix_session.php" style="color: #667eea; font-weight: 600;">Fix Session</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let csvData = [];
        let companies = {};
        let processedData = [];
        let selectedCompanies = new Set();
        let onlineSearchCount = 0;
        let apiAvailable = false;
        
        // Check API status on load
        checkAPIStatus();
        
        // Check API availability
        async function checkAPIStatus() {
            try {
                const response = await fetch('process.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'action=check_api'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('API Status Response:', data); // Debug log
                    
                    apiAvailable = data.api_available || false;
                    
                    if (apiAvailable) {
                        updateAPIStatus(true, 'Gemini AI: Connected ‚úì');
                    } else {
                        updateAPIStatus(false, 'Gemini AI: Add API Key in config.php');
                    }
                } else {
                    console.error('API check failed with status:', response.status);
                    apiAvailable = false;
                    updateAPIStatus(false, 'Gemini AI: Connection Error');
                }
            } catch (error) {
                console.error('API check error:', error);
                apiAvailable = false;
                updateAPIStatus(false, 'Gemini AI: Not Available');
            }
        }
        
        // Update API status indicator
        function updateAPIStatus(available, customText = null) {
            const indicator = document.getElementById('apiIndicator');
            const status = document.getElementById('apiStatus');
            
            if (available) {
                indicator.classList.remove('api-inactive');
                indicator.classList.add('api-active');
                status.textContent = customText || 'Gemini AI: Connected ‚úì';
            } else {
                indicator.classList.remove('api-active');
                indicator.classList.add('api-inactive');
                status.textContent = customText || 'Gemini AI: Not Configured';
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Transliteration function
        function transliterate(text) {
            const map = {
                '√§': 'ae', '√∂': 'oe', '√º': 'ue', '√ü': 'ss',
                '√Ñ': 'Ae', '√ñ': 'Oe', '√ú': 'Ue',
                '√†': 'a', '√¢': 'a', '√ß': 'c', '√®': 'e', '√©': 'e',
                '√™': 'e', '√´': 'e', '√Æ': 'i', '√Ø': 'i', '√¥': 'o',
                '√°': 'a', '√≠': 'i', '√±': 'n', '√≥': 'o', '√∫': 'u',
                '√•': 'aa', '√¶': 'ae', '√∏': 'oe'
            };
            
            let result = '';
            for (let char of text) {
                result += map[char] || char;
            }
            return result;
        }
        
        // File upload handler
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                uploadCSV(file);
            }
        });
        
        // Upload CSV via AJAX
        async function uploadCSV(file) {
            const formData = new FormData();
            formData.append('csv', file);
            formData.append('action', 'upload');
            
            try {
                const response = await fetch('process.php', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showNotification('CSV uploaded successfully!', 'success');
                        parseLocalCSV(file);
                    }
                }
            } catch (error) {
                console.error('Upload error:', error);
                parseLocalCSV(file);
            }
        }
        
        // Parse CSV locally for immediate display
        function parseLocalCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                csvData = [];
                companies = {};
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = parseCSVLine(lines[i]);
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        csvData.push(row);
                        
                        const companyName = row.company_name || row.Company || row.company || '';
                        if (companyName && companyName.trim()) {
                            if (!companies[companyName]) {
                                companies[companyName] = [];
                            }
                            companies[companyName].push(row);
                        }
                    }
                }
                
                displayStats();
                displayCompanies();
            };
            reader.readAsText(file);
        }
        
        // Parse CSV line
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        // Display statistics
        function displayStats() {
            document.getElementById('statsSection').style.display = 'grid';
            document.getElementById('totalLeads').textContent = csvData.length;
            document.getElementById('uniqueCompanies').textContent = Object.keys(companies).length;
        }
        
        // Display companies
        function displayCompanies() {
            const bulkActions = document.getElementById('bulkActions');
            bulkActions.innerHTML = `
                <button class="bulk-btn select-all-btn" onclick="selectAllCompanies()">‚úì Select All</button>
                <button class="bulk-btn deselect-all-btn" onclick="deselectAllCompanies()">‚úó Deselect All</button>
                <button class="bulk-btn search-online-all-btn" onclick="searchAllOnline()">
                    üåê Search All Online
                </button>
                <span style="margin-left: auto; color: #666;">
                    <span id="selectedCount">0</span> of ${Object.keys(companies).length} companies selected
                </span>
            `;
            
            const grid = document.getElementById('companyGrid');
            grid.innerHTML = '';
            
            Object.keys(companies).forEach((company, index) => {
                selectedCompanies.add(index);
                
                const card = document.createElement('div');
                card.className = 'company-card';
                card.id = `company_card_${index}`;
                
                card.innerHTML = `
                    <h3>
                        <span>
                            <input type="checkbox" class="company-checkbox" id="include_${index}" 
                                   checked onchange="toggleCompany(${index})">
                            <label for="include_${index}" style="margin-left: 5px; cursor: pointer;">
                                ${company}
                            </label>
                        </span>
                    </h3>
                    <div class="form-group">
                        <label>
                            Domain:
                            <span id="domain_status_${index}"></span>
                            <span id="domain_source_${index}"></span>
                        </label>
                        <input type="text" id="domain_${index}" placeholder="example.com" value="">
                    </div>
                    <div class="form-group">
                        <label>Email Format:</label>
                        <select id="format_${index}">
                            <option value="firstname.lastname">firstname.lastname@domain</option>
                            <option value="f.lastname">f.lastname@domain</option>
                            <option value="firstname.l">firstname.l@domain</option>
                            <option value="firstnamelastname">firstnamelastname@domain</option>
                            <option value="lastname.firstname">lastname.firstname@domain</option>
                            <option value="firstname">firstname@domain</option>
                            <option value="lastname">lastname@domain</option>
                            <option value="fl">fl@domain (initials)</option>
                            <option value="firstname_lastname">firstname_lastname@domain</option>
                        </select>
                    </div>
                    <button class="search-online-btn" id="search_btn_${index}" 
                            onclick="searchCompanyOnline(${index}, '${company.replace(/'/g, "\\'")}')">
                        üåê Search Online
                    </button>
                    <div class="form-group" style="margin-top: 10px;">
                        <small style="color: #666;">Leads: ${companies[company].length}</small>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            updateSelectedCount();
            document.getElementById('companySection').style.display = 'block';
        }
        
        // Search company online
        async function searchCompanyOnline(index, companyName) {
            const card = document.getElementById(`company_card_${index}`);
            const btn = document.getElementById(`search_btn_${index}`);
            const domainInput = document.getElementById(`domain_${index}`);
            const formatSelect = document.getElementById(`format_${index}`);
            const statusEl = document.getElementById(`domain_status_${index}`);
            const sourceEl = document.getElementById(`domain_source_${index}`);
            
            // Show loading state
            card.classList.add('searching');
            btn.disabled = true;
            btn.textContent = 'üîÑ Searching...';
            
            try {
                const response = await fetch('process.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `action=search_online&company=${encodeURIComponent(companyName)}`
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.domain) {
                        domainInput.value = data.domain;
                        formatSelect.value = data.format || 'firstname.lastname';
                        
                        // Update status
                        let statusClass = 'status-error';
                        let statusText = 'Low confidence';
                        
                        if (data.confidence > 80) {
                            statusClass = 'status-success';
                            statusText = `${data.confidence}% match`;
                        } else if (data.confidence > 50) {
                            statusClass = 'status-warning';
                            statusText = `${data.confidence}% match`;
                        }
                        
                        statusEl.innerHTML = `<span class="status-badge ${statusClass}">${statusText}</span>`;
                        
                        // Show source
                        const sourceMap = {
                            'gemini': 'Gemini AI',
                            'fallback': 'AI Guess',
                            'local': 'Pattern Match'
                        };
                        
                        const sourceName = sourceMap[data.source] || 'Gemini AI';
                        sourceEl.innerHTML = `<span class="source-badge">${sourceName}</span>`;
                        
                        onlineSearchCount++;
                        document.getElementById('onlineSearches').textContent = onlineSearchCount;
                        
                        showNotification(`Found domain for ${companyName}`, 'success');
                    }
                }
            } catch (error) {
                console.error('Search error:', error);
                showNotification(`Failed to search ${companyName}`, 'error');
            } finally {
                card.classList.remove('searching');
                btn.disabled = false;
                btn.textContent = 'üåê Search Online';
            }
        }
        
        // Search all companies online
        async function searchAllOnline() {
            const companyList = Object.keys(companies);
            const totalCompanies = companyList.length;
            
            // Show progress bar
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            progressBar.style.display = 'block';
            
            showNotification(`Starting search for ${totalCompanies} companies...`, 'info');
            
            for (let i = 0; i < companyList.length; i++) {
                if (selectedCompanies.has(i)) {
                    await searchCompanyOnline(i, companyList[i]);
                    
                    // Update progress
                    const progress = Math.round(((i + 1) / totalCompanies) * 100);
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = progress + '%';
                    
                    // Add delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            progressBar.style.display = 'none';
            showNotification('All searches completed!', 'success');
        }
        
        // Toggle company selection
        function toggleCompany(index) {
            const checkbox = document.getElementById(`include_${index}`);
            const card = document.getElementById(`company_card_${index}`);
            
            if (checkbox.checked) {
                selectedCompanies.add(index);
                card.classList.remove('excluded');
            } else {
                selectedCompanies.delete(index);
                card.classList.add('excluded');
            }
            
            updateSelectedCount();
        }
        
        // Update selected count
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedCompanies.size;
        }
        
        // Select all companies
        function selectAllCompanies() {
            Object.keys(companies).forEach((_, index) => {
                document.getElementById(`include_${index}`).checked = true;
                document.getElementById(`company_card_${index}`).classList.remove('excluded');
                selectedCompanies.add(index);
            });
            updateSelectedCount();
        }
        
        // Deselect all companies
        function deselectAllCompanies() {
            Object.keys(companies).forEach((_, index) => {
                document.getElementById(`include_${index}`).checked = false;
                document.getElementById(`company_card_${index}`).classList.add('excluded');
            });
            selectedCompanies.clear();
            updateSelectedCount();
        }
        
        // Generate emails
        async function generateEmails() {
            if (selectedCompanies.size === 0) {
                showNotification('Please select at least one company', 'error');
                return;
            }
            
            console.log('Starting email generation...');
            document.getElementById('loader').style.display = 'block';
            processedData = [];
            
            const mappings = {};
            const excluded = [];
            
            Object.keys(companies).forEach((company, index) => {
                if (selectedCompanies.has(index)) {
                    mappings[company] = {
                        domain: document.getElementById(`domain_${index}`).value,
                        format: document.getElementById(`format_${index}`).value
                    };
                } else {
                    excluded.push(company);
                }
            });
            
            console.log('Sending generation request with', Object.keys(mappings).length, 'companies');
            
            // Send to server for processing
            try {
                const response = await fetch('process.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `action=generate&mappings=${encodeURIComponent(JSON.stringify(mappings))}&excluded=${encodeURIComponent(JSON.stringify(excluded))}`
                });
                
                console.log('Generation response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Generation response data:', data);
                    
                    if (data.success) {
                        processedData = data.preview || [];
                        document.getElementById('emailsGenerated').textContent = data.stats.emails_generated;
                        displayPreview();
                        
                        // Clear any previous error states
                        const downloadSection = document.getElementById('previewSection');
                        if (downloadSection) {
                            downloadSection.style.display = 'block';
                            downloadSection.scrollIntoView({ behavior: 'smooth' });
                        }
                        
                        showNotification(`‚úÖ Successfully generated ${data.stats.emails_generated} emails! You can now download the CSV.`, 'success');
                        
                        // Make download button more prominent
                        const downloadBtn = document.querySelector('.btn-success');
                        if (downloadBtn) {
                            downloadBtn.style.animation = 'pulse 2s infinite';
                            downloadBtn.style.transform = 'scale(1.1)';
                        }
                        
                        console.log('Data stored in session:', data.data_stored);
                        console.log('Session ID:', data.session_id);
                    } else {
                        console.error('Generation failed:', data);
                        showNotification('Email generation failed: ' + (data.error || 'Unknown error'), 'error');
                    }
                } else {
                    console.error('Server error:', response.status);
                    showNotification('Server error during email generation', 'error');
                }
            } catch (error) {
                console.error('Generation error:', error);
                showNotification('Failed to generate emails. Please try again.', 'error');
            }
            
            document.getElementById('loader').style.display = 'none';
        }
        
        // Local email generation
        function generateEmailsLocally(mappings, excluded) {
            processedData = [];
            let emailCount = 0;
            
            Object.keys(companies).forEach((company) => {
                if (excluded.includes(company)) return;
                
                const domain = mappings[company].domain;
                const format = mappings[company].format;
                
                companies[company].forEach(lead => {
                    const firstName = transliterate(lead.firstName || '').toLowerCase().replace(/[^a-z]/g, '');
                    const lastName = transliterate(lead.lastName || '').toLowerCase().replace(/[^a-z]/g, '');
                    
                    let email = '';
                    
                    if (domain && firstName && lastName) {
                        switch(format) {
                            case 'firstname.lastname':
                                email = `${firstName}.${lastName}@${domain}`;
                                break;
                            case 'f.lastname':
                                email = `${firstName[0]}.${lastName}@${domain}`;
                                break;
                            case 'firstname.l':
                                email = `${firstName}.${lastName[0]}@${domain}`;
                                break;
                            case 'firstnamelastname':
                                email = `${firstName}${lastName}@${domain}`;
                                break;
                            case 'lastname.firstname':
                                email = `${lastName}.${firstName}@${domain}`;
                                break;
                            case 'firstname':
                                email = `${firstName}@${domain}`;
                                break;
                            case 'lastname':
                                email = `${lastName}@${domain}`;
                                break;
                            case 'fl':
                                email = `${firstName[0]}${lastName[0]}@${domain}`;
                                break;
                            case 'firstname_lastname':
                                email = `${firstName}_${lastName}@${domain}`;
                                break;
                        }
                        emailCount++;
                    }
                    
                    processedData.push({
                        firstName: lead.firstName || '',
                        lastName: lead.lastName || '',
                        company: company,
                        email: email
                    });
                });
            });
            
            document.getElementById('emailsGenerated').textContent = emailCount;
            displayPreview();
        }
        
        // Display preview
        function displayPreview() {
            const tbody = document.getElementById('previewBody');
            tbody.innerHTML = '';
            
            const previewRows = processedData.slice(0, 10);
            previewRows.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.firstName}</td>
                    <td>${row.lastName}</td>
                    <td>${row.company}</td>
                    <td>${row.email || '<em>No email generated</em>'}</td>
                `;
                tbody.appendChild(tr);
            });
            
            if (processedData.length > 10) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="4" style="text-align: center; font-style: italic;">
                        ... and ${processedData.length - 10} more rows
                    </td>
                `;
                tbody.appendChild(tr);
            }
            
            document.getElementById('previewSection').style.display = 'block';
        }
        
        // Download CSV
        async function downloadCSV() {
            console.log('Starting download process...');
            
            // First check if data is available
            try {
                const checkResponse = await fetch('process.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'action=download_check'
                });
                
                console.log('Download check response status:', checkResponse.status);
                
                if (checkResponse.ok) {
                    const checkData = await checkResponse.json();
                    console.log('Download check data:', checkData);
                    
                    if (checkData.success && checkData.download_ready) {
                        // Data is ready, proceed with download
                        showNotification(`Downloading ${checkData.record_count} records...`, 'success');
                        
                        // Use direct link for download
                        window.location.href = 'process.php?action=download';
                    } else {
                        console.error('Download check failed:', checkData);
                        showNotification('No data available. Please generate emails first.', 'error');
                        
                        // Show debug info
                        if (checkData.debug) {
                            console.log('Debug info:', checkData.debug);
                        }
                    }
                } else {
                    console.error('Download check failed with status:', checkResponse.status);
                    showNotification('Download check failed. Trying direct download...', 'warning');
                    // Try direct download as fallback
                    window.location.href = 'process.php?action=download';
                }
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Error checking download. Trying direct download...', 'warning');
                // Fallback to direct download attempt
                window.location.href = 'process.php?action=download';
            }
        }
    </script>
</body>
</html>